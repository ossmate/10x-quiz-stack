---
import ManagementLayout from "../../layouts/ManagementLayout.astro";
import { QuizDetailContainer } from "../../components/quiz-detail/QuizDetailContainer.tsx";
import { Breadcrumbs } from "../../components/management/Breadcrumbs";
import type { BreadcrumbItem } from "../../types/management.types";

// Set prerender to false as this page requires authentication
export const prerender = false;

// Extract quiz ID from route parameters
const { id } = Astro.params;

// Note: Authentication will be handled by middleware
// If user is not authenticated, they will be redirected to /login
// The quiz ID will be passed to the React component for validation

// Get current user ID from session (set by middleware)
const session = Astro.locals.session;
const currentUserId = session?.userId;

// Ensure quiz ID exists
if (!id) {
  return Astro.redirect("/");
}

// Fetch quiz title for breadcrumbs
let quizTitle = "Loading...";
try {
  const response = await fetch(`${Astro.url.origin}/api/quizzes/${id}`);
  if (response.ok) {
    const quizData = await response.json();
    quizTitle = quizData.title || "Quiz";
  }
} catch {
  // If fetch fails, we'll show "Quiz" as fallback
  quizTitle = "Quiz";
}

// Define breadcrumbs
const breadcrumbs: BreadcrumbItem[] = [
  { label: "Dashboard", path: "/" },
  { label: quizTitle, path: `/quizzes/${id}`, isCurrent: true },
];
---

<ManagementLayout title={`${quizTitle} | QuizStack`}>
  <Breadcrumbs client:load items={breadcrumbs} />

  <QuizDetailContainer client:load quizId={id} currentUserId={currentUserId} />
</ManagementLayout>
