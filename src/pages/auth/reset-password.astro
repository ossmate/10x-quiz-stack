---
import Layout from "../../layouts/Layout.astro";
import { ResetPasswordForm } from "../../components/auth/ResetPasswordForm";
import { createSupabaseServerInstance } from "../../db/supabase.client.ts";

// Create Supabase server instance
const supabase = createSupabaseServerInstance({
  cookies: Astro.cookies,
  headers: Astro.request.headers,
});

// Check for token or code from the URL
const token = Astro.url.searchParams.get("token");
const code = Astro.url.searchParams.get("code");
const type = Astro.url.searchParams.get("type");

let hasValidSession = false;

// If we have a code parameter, try to exchange it for a session
// Supabase sends password reset links with a code parameter
if (code) {
  try {
    // Try PKCE flow first (exchangeCodeForSession)
    const { data, error } = await supabase.auth.exchangeCodeForSession(code);

    if (error) {
      // If PKCE fails, try OTP verification
      // eslint-disable-next-line no-console
      console.error("PKCE code exchange error:", error);

      // Try verifyOtp as fallback
      if (type === "recovery") {
        const { error: otpError } = await supabase.auth.verifyOtp({
          token_hash: code,
          type: "recovery",
        });

        if (otpError) {
          // eslint-disable-next-line no-console
          console.error("OTP verification error:", otpError);
        } else {
          hasValidSession = true;
        }
      }
    } else if (data.session) {
      hasValidSession = true;
    }
  } catch (error) {
    // eslint-disable-next-line no-console
    console.error("Token exchange error:", error);
  }
} else if (token && type === "recovery") {
  // Handle token parameter with type=recovery (older format)
  try {
    const { error } = await supabase.auth.verifyOtp({
      token_hash: token,
      type: "recovery",
    });

    if (error) {
      // eslint-disable-next-line no-console
      console.error("Token verification error:", error);
    } else {
      hasValidSession = true;
    }
  } catch (error) {
    // eslint-disable-next-line no-console
    console.error("Token exchange error:", error);
  }
}

// Double-check if user has a valid session
if (!hasValidSession) {
  const {
    data: { session },
  } = await supabase.auth.getSession();
  hasValidSession = !!session;
}
---

<Layout title="Reset Password - 10x Quiz Stack" showHeader={false}>
  <ResetPasswordForm client:load hasValidSession={hasValidSession} />
</Layout>
