---
import Layout from "../../layouts/Layout.astro";
import { ResetPasswordForm } from "../../components/auth/ResetPasswordForm";
import { createSupabaseServerInstance } from "../../db/supabase.client.ts";

// Create Supabase server instance
const supabase = createSupabaseServerInstance({
  cookies: Astro.cookies,
  headers: Astro.request.headers,
});

// Check for OTP token or code from the URL
const token = Astro.url.searchParams.get("token");
const code = Astro.url.searchParams.get("code");
const type = Astro.url.searchParams.get("type");

// If we have a token or code from the email link, verify it
// Supabase v2 uses 'token' or 'code' parameter with type='recovery'
if ((token || code) && type === "recovery") {
  try {
    // Exchange the token for a session
    const { error } = await supabase.auth.verifyOtp({
      token_hash: token || code || "",
      type: "recovery",
    });

    if (error) {
      // eslint-disable-next-line no-console
      console.error("Token verification error:", error);
    }
  } catch (error) {
    // eslint-disable-next-line no-console
    console.error("Token exchange error:", error);
  }
}

// Check if user has a valid session (from the token exchange above)
const {
  data: { session },
} = await supabase.auth.getSession();

const hasValidSession = !!session;
---

<Layout title="Reset Password - 10x Quiz Stack" showHeader={false}>
  <ResetPasswordForm client:load hasValidSession={hasValidSession} />
</Layout>
